# otelwasm ABI Specification — Version 1

**Status**: Draft
**Authors**: otelwasm contributors
**Related Issue**: [#17 — Refactor (Improve) ABI](https://github.com/otelwasm/otelwasm/issues/17)

## Table of Contents

- [1. Overview](#1-overview)
- [2. Notation and Conventions](#2-notation-and-conventions)
- [3. Types and Constants](#3-types-and-constants)
- [4. Memory Model](#4-memory-model)
- [5. ABI Versioning](#5-abi-versioning)
- [6. Component Lifecycle](#6-component-lifecycle)
- [7. Host Functions](#7-host-functions)
- [8. Guest Functions](#8-guest-functions)
- [9. Data Serialization](#9-data-serialization)
- [10. Error Handling](#10-error-handling)
- [11. WASI Support](#11-wasi-support)
- [Appendix A: Complete ABI Reference](#appendix-a-complete-abi-reference)
- [Appendix B: Mapping to OTel Collector Interfaces](#appendix-b-mapping-to-otel-collector-interfaces)
- [Appendix C: Migration from Experimental ABI](#appendix-c-migration-from-experimental-abi)
- [Appendix D: Future Considerations](#appendix-d-future-considerations)

---

## 1. Overview

The otelwasm ABI (Application Binary Interface) defines the contract between a WebAssembly
(WASM) plugin module (the **guest**) and the otelwasm host runtime that integrates with the
[OpenTelemetry Collector](https://opentelemetry.io/docs/collector/). This specification enables
WASM modules to function as OpenTelemetry Collector components: **receivers**, **processors**,
and **exporters**.

The ABI is designed to closely mirror the OpenTelemetry Collector's native Go interfaces
(`component.Component`, `consumer.Traces/Metrics/Logs`), making it straightforward to port
existing components to WASM and reducing the conceptual gap between native and WASM plugins.

The ABI defines:

- Functions exported by the guest (called by the host)
- Functions imported by the guest from the host
- Memory management conventions
- Data serialization format
- Component lifecycle management

### 1.1 Goals

- **OTel-native**: Direct mapping to OpenTelemetry Collector `component.Component` and
  `consumer` interfaces
- **Simplicity**: Minimal API surface focused on telemetry data processing
- **Language-agnostic**: Any language that compiles to WASM can implement plugins
- **Forward-compatible**: Designed for non-breaking extension in future versions

### 1.2 Non-Goals

- General-purpose plugin framework (this is specific to OTel Collector)
- Network I/O from guest modules (deferred to future versions)
- Inter-plugin communication

---

## 2. Notation and Conventions

### 2.1 Function Signatures

Function signatures use the format:

```
function_name(param1: type, param2: type, ...) -> return_type
```

WASM value types used:

| Type   | WASM Type | Description              |
|--------|-----------|--------------------------|
| `i32`  | `i32`     | 32-bit integer           |
| `i64`  | `i64`     | 64-bit integer           |
| `void` | (none)    | No return value          |

### 2.2 Naming Convention

- All function names use **`snake_case`**.
- Host functions belong to the import module **`otelwasm`**.
- Guest functions are exported from the WASM module's default export namespace (no module
  name).

### 2.3 Byte Order

All multi-byte integer values are encoded in **little-endian** byte order, consistent with the
WebAssembly specification.

### 2.4 Key Words

The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", and "MAY" in this document are to be
interpreted as described in [RFC 2119](https://www.rfc-editor.org/rfc/rfc2119).

---

## 3. Types and Constants

### 3.1 Status Codes

| Name      | Value | Description                                              |
|-----------|-------|----------------------------------------------------------|
| `SUCCESS` | `0`   | Operation completed successfully                         |
| `ERROR`   | `1`   | Operation failed; reason SHOULD be provided via `set_status_reason` |

Guest functions that return a status code MUST use these values. Future ABI versions MAY
introduce additional status codes; hosts SHOULD treat any non-zero value as an error.

### 3.2 Telemetry Type Flags (bitmask)

| Name      | Value  | Description |
|-----------|--------|-------------|
| `METRICS` | `0x01` | Bit 0       |
| `LOGS`    | `0x02` | Bit 1       |
| `TRACES`  | `0x04` | Bit 2       |

Values MAY be combined using bitwise OR (e.g., `METRICS | LOGS | TRACES = 0x07`).

Bits 3–31 are reserved for future signal types (e.g., profiles) and MUST be set to `0` in v1.

### 3.3 Log Levels

| Name    | Value | Description               |
|---------|-------|---------------------------|
| `TRACE` | `0`   | Finest-grained information |
| `DEBUG` | `1`   | Debugging information      |
| `INFO`  | `2`   | Informational messages     |
| `WARN`  | `3`   | Warning conditions         |
| `ERROR` | `4`   | Error conditions           |

---

## 4. Memory Model

### 4.1 Linear Memory

The guest module MUST export exactly one linear memory named **`memory`**. All pointer-based
data exchange between host and guest occurs through this memory.

### 4.2 Guest Memory Allocator

The guest module MUST export a memory allocation function:

```
alloc(size: i32) -> i32
```

- Allocates `size` bytes in the guest's linear memory.
- Returns a pointer (`i32`) to the allocated region.
- Returns `0` if allocation fails.

The host calls `alloc` when it needs to write data into guest memory (e.g., before calling
`consume_traces` with telemetry data). The guest is responsible for freeing the allocated
memory after it has finished processing the data.

**Rationale**: This approach mirrors the standard WASM ABI pattern (used by proxy-wasm's
`proxy_on_memory_allocate`) and enables the host to push data directly to the guest, aligning
with the OpenTelemetry Collector's consumer interface where data is pushed to components.

### 4.3 Buffer Passing Convention (Guest-to-Host)

For host functions that return variable-size data to the guest (e.g., plugin configuration),
the **buffer-passing** convention is used:

```
host_function(buf_ptr: i32, buf_limit: i32) -> i32 (actual_size)
```

- `buf_ptr` — Pointer to a pre-allocated buffer in guest linear memory.
- `buf_limit` — Maximum number of bytes the buffer can hold.
- Return value (`actual_size`) — The actual size of the data.

**Behavior:**

| Condition                  | Data Written? | Guest Action                     |
|----------------------------|---------------|----------------------------------|
| `actual_size <= buf_limit` | Yes           | Read data from buffer            |
| `actual_size > buf_limit`  | No            | Grow buffer, call again          |
| `actual_size == 0`         | No            | No data available                |

### 4.4 Host-to-Guest Data Transfer (Push Model)

For telemetry data flowing through the pipeline, the host **pushes** data to the guest:

1. Host serializes the telemetry data.
2. Host calls `alloc(data_size)` to allocate memory in the guest.
3. Host writes the serialized data into the allocated region.
4. Host calls the guest's consumer function (e.g., `consume_traces(data_ptr, data_size)`).
5. The guest owns the allocated memory and is responsible for freeing it.

This push model directly mirrors the OpenTelemetry Collector's `consumer.ConsumeTraces(ctx,
ptrace.Traces)` interface.

### 4.5 Guest-to-Host Data Transfer

For submitting data from the guest to the host (e.g., processed telemetry, receiver output):

1. Guest writes the data into its own linear memory.
2. Guest calls a host function with `(data_ptr: i32, data_size: i32)`.
3. Host reads `data_size` bytes starting at `data_ptr` from guest memory.

---

## 5. ABI Versioning

### 5.1 Version Marker

The guest module MUST export an empty function to declare ABI version compliance:

```
abi_version_v1() -> void
```

This function is **never called** by the host. Its presence in the module's export table serves
as a static marker for ABI version detection, following the convention established by
[proxy-wasm](https://github.com/proxy-wasm/spec).

### 5.2 Host Detection Behavior

The host MUST check for ABI version marker exports before interacting with the module:

1. Check for `abi_version_v1` export → use ABI v1 semantics.
2. If no recognized version marker is found → fall back to experimental ABI (if supported) or
   reject the module with a clear error message.

### 5.3 Forward Compatibility

Future ABI versions will use markers named `abi_version_v2`, `abi_version_v3`, etc. A module
MAY export multiple version markers to indicate compatibility with multiple ABI versions. When
multiple markers are present, the host SHOULD use the highest version it supports.

---

## 6. Component Lifecycle

The lifecycle is modeled after the OpenTelemetry Collector's `component.Component` interface
(`Start` + `Shutdown`).

### 6.1 Phases

```
Module Load
  → ABI version detection
    → start()                             ← component.Start(ctx, host)
      → [Component operations]
        → shutdown()                      ← component.Shutdown(ctx)
          → Module unload
```

### 6.2 Module Load

The host loads the WASM binary and instantiates the module. During this phase:

- The host provides all imported functions (see §7).
- WASI imports are initialized if the guest requires them.
- The guest's `_start` or `_initialize` function is called if present (per WASM convention).

This phase corresponds to the Collector's factory `Create*()` method, where the component is
constructed with its configuration.

### 6.3 ABI Version Detection

After instantiation, the host checks for ABI version marker exports (see §5.2).

### 6.4 Start (`start`)

The host calls `start()`. This maps to `component.Component.Start(ctx, host)`.

During this phase, the guest MAY:

- Call `get_plugin_config()` to retrieve and validate configuration.
- Initialize internal state and resources.
- Call `log()` to emit diagnostic messages.

The guest MUST return `SUCCESS` (0) to indicate readiness. If the guest returns `ERROR` (1),
the host MUST abort component startup and SHOULD log the reason provided via
`set_status_reason()`.

The `start()` function MUST return promptly. Long-running initialization is discouraged.

### 6.5 Component Operations

Depending on the component type:

- **Processors**: The host calls `consume_traces`, `consume_metrics`, or `consume_logs` for
  each batch of telemetry data passing through the pipeline. The guest processes the data and
  calls `set_result_*()` to forward results to the next pipeline stage.
- **Exporters**: The host calls `consume_traces`, `consume_metrics`, or `consume_logs` for
  each batch of telemetry data to be exported. The guest handles the export operation and
  returns a status.
- **Receivers**: The host calls `start_traces_receiver`, `start_metrics_receiver`, or
  `start_logs_receiver` once. The function blocks until shutdown is requested, emitting
  telemetry via `set_result_*()`.

### 6.6 Shutdown (`shutdown`)

This maps to `component.Component.Shutdown(ctx)`.

When the OpenTelemetry Collector is shutting down:

1. For receivers: the host sets the shutdown flag (readable via `get_shutdown_requested()`),
   causing the receiver loop to exit.
2. The host waits for any in-flight operations to complete.
3. The host calls `shutdown()`.
4. The guest performs cleanup and returns a `StatusCode`.
5. The host unloads the WASM module.

---

## 7. Host Functions

These functions are provided by the host and imported by the guest. They belong to the import
module named **`otelwasm`**.

### 7.1 Next Consumer (Result Submission)

These functions correspond to calling the **next consumer** in the OpenTelemetry Collector
pipeline. For processors, this forwards data to the next pipeline stage. For receivers, this
emits generated data into the pipeline.

#### `set_result_traces`

```
set_result_traces(data_ptr: i32, data_size: i32) -> void
```

Submits traces data (OTLP protobuf binary) to the next consumer in the pipeline.

- For **processors**: submits the processed/modified traces. Maps to
  `nextConsumer.ConsumeTraces(ctx, td)`.
- For **receivers**: emits generated traces into the pipeline. MAY be called multiple times
  during a single receiver invocation.
- For **exporters**: not typically used (exporters are the terminal stage).

**Valid context**: During `consume_traces` and `start_traces_receiver` invocations.

#### `set_result_metrics`

```
set_result_metrics(data_ptr: i32, data_size: i32) -> void
```

Submits metrics data to the next consumer in the pipeline.

**Valid context**: During `consume_metrics` and `start_metrics_receiver` invocations.

#### `set_result_logs`

```
set_result_logs(data_ptr: i32, data_size: i32) -> void
```

Submits logs data to the next consumer in the pipeline.

**Valid context**: During `consume_logs` and `start_logs_receiver` invocations.

### 7.2 Configuration

#### `get_plugin_config`

```
get_plugin_config(buf_ptr: i32, buf_limit: i32) -> i32
```

Retrieves the plugin configuration as a JSON-encoded byte string using the buffer-passing
convention (§4.3). The JSON content corresponds to the `plugin_config` section of the
component's YAML configuration.

**Valid context**: At any time after module instantiation.

### 7.3 Status Reporting

#### `set_status_reason`

```
set_status_reason(msg_ptr: i32, msg_size: i32) -> void
```

Sets a human-readable UTF-8 error message. This SHOULD be called before returning a non-zero
status code from any guest function. The host reads `msg_size` bytes starting at `msg_ptr`.

**Valid context**: At any time during a guest function invocation.

### 7.4 Lifecycle Support

#### `get_shutdown_requested`

```
get_shutdown_requested() -> i32
```

Returns `1` if the host has requested shutdown, `0` otherwise.

**Valid context**: Primarily used within receiver loops to detect graceful shutdown. MAY be
called at any time.

### 7.5 Logging

#### `log`

```
log(level: i32, msg_ptr: i32, msg_size: i32) -> void
```

Emits a log message through the host's logging infrastructure (typically the OpenTelemetry
Collector's logger). The message MUST be a valid UTF-8 string.

- `level` — One of the log levels defined in §3.3.
- `msg_ptr` — Pointer to the UTF-8 message in guest memory.
- `msg_size` — Length of the message in bytes.

The host SHOULD forward the message to its configured logger at the appropriate level. Messages
with a level below the host's configured threshold MAY be silently discarded.

**Valid context**: At any time after module instantiation.

---

## 8. Guest Functions

These functions are exported by the guest module and called by the host.

### 8.1 Required Exports

Every otelwasm v1 plugin MUST export the following.

#### `abi_version_v1`

```
abi_version_v1() -> void
```

ABI version marker (see §5.1). Never called by the host.

#### `alloc`

```
alloc(size: i32) -> i32
```

Memory allocation function (see §4.2). Called by the host to allocate memory in the guest
before pushing telemetry data.

#### `get_supported_telemetry`

```
get_supported_telemetry() -> i32
```

Returns a bitmask of supported telemetry types (see §3.2). The host uses this to validate
that the plugin supports the required signals for its configured role.

#### `start`

```
start() -> i32
```

Called once to initialize and start the component. Maps to `component.Component.Start(ctx,
host)` (see §6.4). Returns a `StatusCode` (§3.1).

#### `shutdown`

```
shutdown() -> i32
```

Called once to shut down the component. Maps to `component.Component.Shutdown(ctx)` (see
§6.6). Returns a `StatusCode` (§3.1). MUST be safe to call even if `start()` was not called
or returned an error.

### 8.2 Consumer Functions (Processors and Exporters)

Both processors and exporters implement the consumer interface, mirroring the OpenTelemetry
Collector's design where `processor.Traces` and `exporter.Traces` both embed
`consumer.Traces`.

Plugins acting as **processors** or **exporters** MUST export one or more of the following,
corresponding to the telemetry types declared by `get_supported_telemetry()`.

#### `consume_traces`

```
consume_traces(data_ptr: i32, data_size: i32) -> i32
```

Consume a batch of traces. Maps to `consumer.ConsumeTraces(ctx, ptrace.Traces)`.

- `data_ptr` — Pointer to OTLP protobuf-encoded traces data in guest memory (allocated by the
  host via `alloc`).
- `data_size` — Size of the serialized data in bytes.
- Returns a `StatusCode`.

**For processors**, the guest SHOULD:

1. Read and deserialize the traces data from `data_ptr`.
2. Process/transform the data.
3. Call `set_result_traces()` to forward the result to the next consumer.
4. Return a `StatusCode`.

If `set_result_traces()` is not called and the function returns `SUCCESS`, the host SHOULD
treat the original data as unchanged and pass it through.

**For exporters**, the guest SHOULD:

1. Read and deserialize the traces data from `data_ptr`.
2. Perform the export operation.
3. Return a `StatusCode`.

#### `consume_metrics`

```
consume_metrics(data_ptr: i32, data_size: i32) -> i32
```

Consume a batch of metrics. Maps to `consumer.ConsumeMetrics(ctx, pmetric.Metrics)`.
Same protocol as `consume_traces`.

#### `consume_logs`

```
consume_logs(data_ptr: i32, data_size: i32) -> i32
```

Consume a batch of logs. Maps to `consumer.ConsumeLogs(ctx, plog.Logs)`.
Same protocol as `consume_traces`.

### 8.3 Receiver Functions

Plugins acting as **receivers** MUST export one or more of the following.

Receivers do NOT implement the consumer interface (they produce data, not consume it), matching
the Collector's design where `receiver.Traces` embeds only `component.Component`.

#### `start_traces_receiver`

```
start_traces_receiver() -> void
```

Start the traces receiver. This function **blocks** until shutdown is requested. The guest
SHOULD:

1. Enter a loop.
2. Generate or collect telemetry data.
3. Call `set_result_traces()` to emit data into the pipeline (acting as the next consumer).
4. Check `get_shutdown_requested()` periodically.
5. Exit the loop when shutdown is indicated.

#### `start_metrics_receiver`

```
start_metrics_receiver() -> void
```

Start the metrics receiver. Same protocol as `start_traces_receiver`.

#### `start_logs_receiver`

```
start_logs_receiver() -> void
```

Start the logs receiver. Same protocol as `start_traces_receiver`.

---

## 9. Data Serialization

### 9.1 Telemetry Data

All telemetry data exchanged between host and guest MUST be serialized using **Protocol Buffers
binary encoding** with the following message types from the
[OpenTelemetry Proto](https://github.com/open-telemetry/opentelemetry-proto) definitions:

| Signal  | Protobuf Message                                |
|---------|--------------------------------------------------|
| Traces  | `opentelemetry.proto.trace.v1.TracesData`        |
| Metrics | `opentelemetry.proto.metrics.v1.MetricsData`     |
| Logs    | `opentelemetry.proto.logs.v1.LogsData`           |

These are the same internal data representations used by the OpenTelemetry Collector's
`pdata` package (`ptrace.Traces`, `pmetric.Metrics`, `plog.Logs`).

### 9.2 Configuration

Plugin configuration MUST be serialized as **UTF-8 encoded JSON**. The JSON structure
corresponds to the `plugin_config` section of the component's YAML configuration, converted
using the standard YAML-to-JSON mapping.

### 9.3 Text Data

All text data exchanged through the ABI (status reasons, log messages) MUST be valid **UTF-8**
encoded strings.

---

## 10. Error Handling

### 10.1 Guest Function Errors

When a guest function returns a non-zero `StatusCode`:

1. The guest SHOULD call `set_status_reason()` before returning to provide a human-readable
   error description.
2. The host SHOULD log the error, including the status reason if available.
3. The host SHOULD propagate the error to the OpenTelemetry Collector pipeline, which may
   trigger retry logic or error reporting depending on the pipeline configuration.

### 10.2 Host Function Errors

The host MAY **trap** (abort) the WASM module for unrecoverable errors such as:

- Guest passes an invalid memory address.
- Guest calls a context-restricted function outside its valid context.

### 10.3 Allocation Failures

If `alloc` returns `0` (allocation failure), the host SHOULD:

1. Treat the current operation as failed.
2. Return an error to the Collector pipeline (which may trigger retry or drop the data).
3. The host MAY log a warning about the allocation failure.

### 10.4 WASM Traps

If a WASM trap occurs (e.g., unreachable instruction, out-of-bounds memory access, stack
overflow), the host SHOULD:

1. Log the trap with available diagnostic information.
2. Report the error to the OpenTelemetry Collector pipeline.
3. The host MAY optionally restart the WASM module for subsequent invocations.

---

## 11. WASI Support

Guest modules MAY use
[WASI preview 1](https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md)
imports for:

- Standard I/O (`fd_write` to stdout/stderr)
- Clock access (`clock_time_get`)
- Random number generation (`random_get`)
- Environment variables (`environ_get`, `environ_sizes_get`)

The host SHOULD provide WASI preview 1 support. Output written to stdout and stderr SHOULD be
forwarded to the host's logging infrastructure.

> **Note**: Guest modules SHOULD prefer the `log` host function (§7.5) over WASI stdio for
> logging, as it provides structured log levels.

---

## Appendix A: Complete ABI Reference

### Host Functions (import module: `otelwasm`)

| Function                 | WASM Signature              | Description                        |
|--------------------------|-----------------------------|------------------------------------|
| `set_result_traces`      | `(i32, i32) -> ()`         | Forward traces to next consumer    |
| `set_result_metrics`     | `(i32, i32) -> ()`         | Forward metrics to next consumer   |
| `set_result_logs`        | `(i32, i32) -> ()`         | Forward logs to next consumer      |
| `get_plugin_config`      | `(i32, i32) -> (i32)`      | Read plugin configuration (JSON)   |
| `set_status_reason`      | `(i32, i32) -> ()`         | Set error reason string            |
| `get_shutdown_requested` | `() -> (i32)`               | Check shutdown flag                |
| `log`                    | `(i32, i32, i32) -> ()`    | Emit log message                   |

### Guest Exports

| Function                   | WASM Signature         | Required | Description                     |
|----------------------------|------------------------|----------|---------------------------------|
| `abi_version_v1`           | `() -> ()`             | Yes      | ABI version marker              |
| `alloc`                    | `(i32) -> (i32)`       | Yes      | Allocate guest memory for host  |
| `get_supported_telemetry`  | `() -> (i32)`          | Yes      | Supported telemetry bitmask     |
| `start`                    | `() -> (i32)`          | Yes      | Start component                 |
| `shutdown`                 | `() -> (i32)`          | Yes      | Shutdown component              |
| `consume_traces`           | `(i32, i32) -> (i32)`  | No\*     | Consume traces (proc/exp)       |
| `consume_metrics`          | `(i32, i32) -> (i32)`  | No\*     | Consume metrics (proc/exp)      |
| `consume_logs`             | `(i32, i32) -> (i32)`  | No\*     | Consume logs (proc/exp)         |
| `start_traces_receiver`    | `() -> ()`             | No\*     | Start traces receiver           |
| `start_metrics_receiver`   | `() -> ()`             | No\*     | Start metrics receiver          |
| `start_logs_receiver`      | `() -> ()`             | No\*     | Start logs receiver             |

\* Required based on the component type and the telemetry signals declared by
`get_supported_telemetry()`. Processors and exporters MUST export the appropriate `consume_*`
functions. Receivers MUST export the appropriate `start_*_receiver` functions.

---

## Appendix B: Mapping to OTel Collector Interfaces

This section shows the direct correspondence between otelwasm ABI v1 functions and the
OpenTelemetry Collector's Go interfaces.

### component.Component

```go
type Component interface {
    Start(ctx context.Context, host Host) error
    Shutdown(ctx context.Context) error
}
```

| Go Interface                            | ABI v1 Guest Export   |
|-----------------------------------------|-----------------------|
| `component.Start(ctx, host) error`      | `start() -> i32`      |
| `component.Shutdown(ctx) error`         | `shutdown() -> i32`   |

### consumer.Traces / Metrics / Logs

```go
type Traces interface {
    ConsumeTraces(ctx context.Context, td ptrace.Traces) error
}
```

| Go Interface                                          | ABI v1 Guest Export                      |
|-------------------------------------------------------|------------------------------------------|
| `consumer.ConsumeTraces(ctx, ptrace.Traces) error`    | `consume_traces(ptr, size) -> i32`       |
| `consumer.ConsumeMetrics(ctx, pmetric.Metrics) error` | `consume_metrics(ptr, size) -> i32`      |
| `consumer.ConsumeLogs(ctx, plog.Logs) error`          | `consume_logs(ptr, size) -> i32`         |

### Next Consumer (Pipeline Forwarding)

```go
// Inside a processor:
next.ConsumeTraces(ctx, modifiedTraces)
```

| Go Pattern                                              | ABI v1 Host Function                   |
|---------------------------------------------------------|----------------------------------------|
| `nextConsumer.ConsumeTraces(ctx, td)`                   | `set_result_traces(ptr, size)`         |
| `nextConsumer.ConsumeMetrics(ctx, md)`                  | `set_result_metrics(ptr, size)`        |
| `nextConsumer.ConsumeLogs(ctx, ld)`                     | `set_result_logs(ptr, size)`           |

### Component Types

| OTel Collector Type    | Go Interface                               | ABI v1 Guest Exports                          |
|------------------------|--------------------------------------------|-----------------------------------------------|
| `processor.Traces`     | `component.Component + consumer.Traces`    | `start` + `shutdown` + `consume_traces`       |
| `processor.Metrics`    | `component.Component + consumer.Metrics`   | `start` + `shutdown` + `consume_metrics`      |
| `processor.Logs`       | `component.Component + consumer.Logs`      | `start` + `shutdown` + `consume_logs`         |
| `exporter.Traces`      | `component.Component + consumer.Traces`    | `start` + `shutdown` + `consume_traces`       |
| `exporter.Metrics`     | `component.Component + consumer.Metrics`   | `start` + `shutdown` + `consume_metrics`      |
| `exporter.Logs`        | `component.Component + consumer.Logs`      | `start` + `shutdown` + `consume_logs`         |
| `receiver.Traces`      | `component.Component`                      | `start` + `shutdown` + `start_traces_receiver`|
| `receiver.Metrics`     | `component.Component`                      | `start` + `shutdown` + `start_metrics_receiver`|
| `receiver.Logs`        | `component.Component`                      | `start` + `shutdown` + `start_logs_receiver`  |

### Factory and Configuration

| OTel Collector Pattern                                                  | ABI v1 Equivalent                          |
|-------------------------------------------------------------------------|--------------------------------------------|
| `factory.CreateDefaultConfig() component.Config`                        | `get_plugin_config()` host function        |
| `factory.CreateTraces(ctx, settings, config, next) (processor.Traces)`  | Module load + `start()` + `consume_traces` |
| `settings.ID`                                                           | Managed by host configuration              |
| `settings.TelemetrySettings` (logger)                                   | `log()` host function                      |

---

## Appendix C: Migration from Experimental ABI

### C.1 Architectural Changes

The most significant change from the experimental ABI to v1 is the shift from a **pull model**
to a **push model** for telemetry data:

| Aspect                | Experimental ABI                          | v1 ABI                                    |
|-----------------------|-------------------------------------------|-------------------------------------------|
| **Data flow**         | Guest pulls via `get_current_*()`         | Host pushes via `consume_*(ptr, size)`    |
| **Memory allocation** | Guest pre-allocates, two-pass retry       | Host allocates via guest's `alloc()`      |
| **Proc/Exp interface**| Separate: `process_*()` / `push_*()`     | Unified: `consume_*()`                    |
| **Lifecycle**         | `plugin_init` / `plugin_shutdown`         | `start` / `shutdown`                      |

### C.2 Function Mapping

| Experimental ABI                  | v1 ABI                       | Change                              |
|-----------------------------------|------------------------------|-------------------------------------|
| Module: `opentelemetry.io/wasm`   | Module: `otelwasm`           | Module name simplified              |
| `currentTraces(buf, limit)`       | *(removed)*                  | Replaced by push model              |
| `currentMetrics(buf, limit)`      | *(removed)*                  | Replaced by push model              |
| `currentLogs(buf, limit)`         | *(removed)*                  | Replaced by push model              |
| `setResultTraces`                 | `set_result_traces`          | Renamed (snake\_case)               |
| `setResultMetrics`                | `set_result_metrics`         | Renamed                             |
| `setResultLogs`                   | `set_result_logs`            | Renamed                             |
| `getPluginConfig`                 | `get_plugin_config`          | Renamed                             |
| `setResultStatusReason`           | `set_status_reason`          | Renamed, shortened                  |
| `getShutdownRequested`            | `get_shutdown_requested`     | Renamed                             |
| `getSupportedTelemetry`           | `get_supported_telemetry`    | Renamed                             |
| `processTraces()`                 | `consume_traces(ptr, size)`  | Renamed, push model                 |
| `processMetrics()`                | `consume_metrics(ptr, size)` | Renamed, push model                 |
| `processLogs()`                   | `consume_logs(ptr, size)`    | Renamed, push model                 |
| `pushTraces()`                    | `consume_traces(ptr, size)`  | Unified with processor              |
| `pushMetrics()`                   | `consume_metrics(ptr, size)` | Unified with processor              |
| `pushLogs()`                      | `consume_logs(ptr, size)`    | Unified with processor              |
| `startTracesReceiver`             | `start_traces_receiver`      | Renamed                             |
| `startMetricsReceiver`            | `start_metrics_receiver`     | Renamed                             |
| `startLogsReceiver`               | `start_logs_receiver`        | Renamed                             |
| *(not present)*                   | `abi_version_v1`             | **New**: ABI version marker         |
| *(not present)*                   | `alloc`                      | **New**: Guest memory allocator     |
| *(not present)*                   | `start`                      | **New**: Component start            |
| *(not present)*                   | `shutdown`                   | **New**: Component shutdown         |
| *(not present)*                   | `log`                        | **New**: Structured logging         |

### C.3 Migration Strategy

The host SHOULD support both the experimental ABI and v1 ABI simultaneously during a
transition period:

1. On module load, check for `abi_version_v1` export.
2. If present, use v1 ABI semantics (push model, snake\_case names).
3. If absent, fall back to experimental ABI semantics (pull model, camelCase names).

This allows existing plugins to continue working while new plugins adopt v1.

---

## Appendix D: Future Considerations

The following features are **out of scope** for v1 but are being considered for future
versions:

- **HTTP client host functions** — Enabling exporters to make outbound HTTP requests from
  within the WASM sandbox.
- **Timer/tick model for receivers** — An alternative to the blocking receiver model where the
  host periodically calls a guest tick function.
- **Profiles signal support** — When the OpenTelemetry profiles signal stabilizes, a new
  telemetry type flag and corresponding functions will be added.
- **Connector component support** — OpenTelemetry Collector connectors bridge between
  pipelines; ABI support may be added in the future.
- **Plugin metadata** — Guest-declared metadata such as plugin name, version, and description.
- **Shared state / key-value store** — Host-managed shared state accessible to plugins, similar
  to proxy-wasm's shared data mechanism.
- **Backpressure signaling** — Mechanism for the host to signal the guest to slow down data
  emission (relevant for receivers).
- **Consumer capabilities** — Exposing `consumer.Capabilities` (e.g., `MutatesData` flag) for
  pipeline optimization.
