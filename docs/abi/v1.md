# otelwasm ABI Specification — Version 1

**Status**: Draft
**Authors**: otelwasm contributors
**Related Issue**: [#17 — Refactor (Improve) ABI](https://github.com/otelwasm/otelwasm/issues/17)

## Table of Contents

- [1. Overview](#1-overview)
- [2. Notation and Conventions](#2-notation-and-conventions)
- [3. Types and Constants](#3-types-and-constants)
- [4. Memory Model](#4-memory-model)
- [5. ABI Versioning](#5-abi-versioning)
- [6. Plugin Lifecycle](#6-plugin-lifecycle)
- [7. Host Functions](#7-host-functions)
- [8. Guest Functions](#8-guest-functions)
- [9. Data Serialization](#9-data-serialization)
- [10. Error Handling](#10-error-handling)
- [11. WASI Support](#11-wasi-support)
- [Appendix A: Complete ABI Reference](#appendix-a-complete-abi-reference)
- [Appendix B: Migration from Experimental ABI](#appendix-b-migration-from-experimental-abi)
- [Appendix C: Future Considerations](#appendix-c-future-considerations)

---

## 1. Overview

The otelwasm ABI (Application Binary Interface) defines the contract between a WebAssembly
(WASM) plugin module (the **guest**) and the otelwasm host runtime that integrates with the
[OpenTelemetry Collector](https://opentelemetry.io/docs/collector/). This specification enables
WASM modules to function as OpenTelemetry Collector components: **receivers**, **processors**,
and **exporters**.

The ABI defines:

- Functions exported by the guest (called by the host)
- Functions imported by the guest from the host
- Memory management conventions
- Data serialization format
- Lifecycle management

### 1.1 Goals

- **Simplicity**: Minimal API surface focused on OpenTelemetry data processing
- **Language-agnostic**: Any language that compiles to WASM can implement plugins
- **OTel-native**: Aligned with OpenTelemetry Collector component interfaces
- **Forward-compatible**: Designed for non-breaking extension in future versions

### 1.2 Non-Goals

- General-purpose plugin framework (this is specific to OTel Collector)
- Network I/O from guest modules (deferred to future versions)
- Inter-plugin communication

---

## 2. Notation and Conventions

### 2.1 Function Signatures

Function signatures use the format:

```
function_name(param1: type, param2: type, ...) -> return_type
```

WASM value types used:

| Type   | WASM Type | Description              |
|--------|-----------|--------------------------|
| `i32`  | `i32`     | 32-bit integer           |
| `i64`  | `i64`     | 64-bit integer           |
| `void` | (none)    | No return value          |

### 2.2 Naming Convention

- All function names use **`snake_case`**.
- Host functions belong to the import module **`otelwasm`**.
- Guest functions are exported from the WASM module's default export namespace (no module name).

### 2.3 Byte Order

All multi-byte integer values are encoded in **little-endian** byte order, consistent with the
WebAssembly specification.

### 2.4 Key Words

The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", and "MAY" in this document are to be
interpreted as described in [RFC 2119](https://www.rfc-editor.org/rfc/rfc2119).

---

## 3. Types and Constants

### 3.1 Status Codes

| Name      | Value | Description                                              |
|-----------|-------|----------------------------------------------------------|
| `SUCCESS` | `0`   | Operation completed successfully                         |
| `ERROR`   | `1`   | Operation failed; reason SHOULD be provided via `set_status_reason` |

Guest functions that return a status code MUST use these values. Future ABI versions MAY
introduce additional status codes; hosts SHOULD treat any non-zero value as an error.

### 3.2 Telemetry Type Flags (bitmask)

| Name      | Value  | Description |
|-----------|--------|-------------|
| `METRICS` | `0x01` | Bit 0       |
| `LOGS`    | `0x02` | Bit 1       |
| `TRACES`  | `0x04` | Bit 2       |

Values MAY be combined using bitwise OR (e.g., `METRICS | LOGS | TRACES = 0x07`).

Bits 3–31 are reserved for future signal types (e.g., profiles) and MUST be set to `0` in v1.

### 3.3 Log Levels

| Name    | Value | Description               |
|---------|-------|---------------------------|
| `TRACE` | `0`   | Finest-grained information |
| `DEBUG` | `1`   | Debugging information      |
| `INFO`  | `2`   | Informational messages     |
| `WARN`  | `3`   | Warning conditions         |
| `ERROR` | `4`   | Error conditions           |

---

## 4. Memory Model

### 4.1 Linear Memory

The guest module MUST export exactly one linear memory named **`memory`**. All pointer-based
data exchange between host and guest occurs through this memory.

### 4.2 Buffer Passing Convention

Many host functions use a **buffer-passing** convention for returning variable-size data to the
guest:

```
host_function(buf_ptr: i32, buf_limit: i32) -> i32 (actual_size)
```

- `buf_ptr` — Pointer to a pre-allocated buffer in guest linear memory.
- `buf_limit` — Maximum number of bytes the buffer can hold.
- Return value (`actual_size`) — The actual size of the serialized data.

**Behavior:**

| Condition                 | Data Written? | Guest Action                     |
|---------------------------|---------------|----------------------------------|
| `actual_size <= buf_limit` | Yes           | Read data from buffer            |
| `actual_size > buf_limit`  | No            | Grow buffer, call again          |
| `actual_size == 0`         | No            | No data available                |

This two-pass approach allows the guest to manage its own memory without requiring the host to
call back into the guest for allocation.

### 4.3 Guest-to-Host Data Transfer

For submitting data from the guest to the host (e.g., result telemetry, status messages):

1. Guest writes the data into its own linear memory.
2. Guest calls a host function with `(data_ptr: i32, data_size: i32)`.
3. Host reads `data_size` bytes starting at `data_ptr` from guest memory.

### 4.4 Data Stability Guarantee

Within a single guest function invocation, the data available through host functions (e.g.,
current telemetry data, plugin configuration) is guaranteed to remain **stable**. The guest MAY
call the same host function multiple times during one invocation and will receive the same data.

---

## 5. ABI Versioning

### 5.1 Version Marker

The guest module MUST export an empty function to declare ABI version compliance:

```
abi_version_v1() -> void
```

This function is **never called** by the host. Its presence in the module's export table serves
as a static marker for ABI version detection, following the convention established by
[proxy-wasm](https://github.com/proxy-wasm/spec).

### 5.2 Host Detection Behavior

The host MUST check for ABI version marker exports before interacting with the module:

1. Check for `abi_version_v1` export → use ABI v1 semantics.
2. If no recognized version marker is found → fall back to experimental ABI (if supported) or
   reject the module with a clear error message.

### 5.3 Forward Compatibility

Future ABI versions will use markers named `abi_version_v2`, `abi_version_v3`, etc. A module
MAY export multiple version markers to indicate compatibility with multiple ABI versions. When
multiple markers are present, the host SHOULD use the highest version it supports.

---

## 6. Plugin Lifecycle

### 6.1 Phases

```
Module Load
  → ABI version detection
    → plugin_init()
      → [Component operations: process / push / start_receiver]
        → plugin_shutdown()
          → Module unload
```

### 6.2 Module Load

The host loads the WASM binary and instantiates the module. During this phase:

- The host provides all imported functions (see §7).
- WASI imports are initialized if the guest requires them.
- The guest's `_start` or `_initialize` function is called if present (per WASM convention).

### 6.3 ABI Version Detection

After instantiation, the host checks for ABI version marker exports (see §5.2).

### 6.4 Initialization (`plugin_init`)

The host calls `plugin_init()`. During this phase, the guest MAY:

- Call `get_plugin_config()` to retrieve and validate configuration.
- Initialize internal state and resources.
- Call `log()` to emit diagnostic messages.

The guest MUST return `SUCCESS` (0) to indicate readiness. If the guest returns `ERROR` (1),
the host MUST abort plugin loading and SHOULD log the reason provided via `set_status_reason()`.

### 6.5 Component Operations

Depending on the component type:

- **Processors**: The host calls `process_traces`, `process_metrics`, or `process_logs` for
  each batch of telemetry data passing through the pipeline.
- **Exporters**: The host calls `push_traces`, `push_metrics`, or `push_logs` for each batch
  of telemetry data to be exported.
- **Receivers**: The host calls `start_traces_receiver`, `start_metrics_receiver`, or
  `start_logs_receiver` once. The function blocks until shutdown is requested.

### 6.6 Shutdown

When the OpenTelemetry Collector is shutting down:

1. For receivers: the host sets the shutdown flag (readable via `get_shutdown_requested()`),
   causing the receiver loop to exit.
2. The host waits for any in-flight operations to complete.
3. The host calls `plugin_shutdown()`.
4. The guest performs cleanup and returns a `StatusCode`.
5. The host unloads the WASM module.

---

## 7. Host Functions

These functions are provided by the host and imported by the guest. They belong to the import
module named **`otelwasm`**.

### 7.1 Telemetry Data Access

#### `get_current_traces`

```
get_current_traces(buf_ptr: i32, buf_limit: i32) -> i32
```

Reads the current traces data into the guest buffer using the buffer-passing convention (§4.2).
Data is serialized in OTLP protobuf binary format (see §9.1).

**Valid context**: During `process_traces` and `push_traces` invocations.

#### `get_current_metrics`

```
get_current_metrics(buf_ptr: i32, buf_limit: i32) -> i32
```

Reads the current metrics data into the guest buffer.

**Valid context**: During `process_metrics` and `push_metrics` invocations.

#### `get_current_logs`

```
get_current_logs(buf_ptr: i32, buf_limit: i32) -> i32
```

Reads the current logs data into the guest buffer.

**Valid context**: During `process_logs` and `push_logs` invocations.

### 7.2 Result Submission

#### `set_result_traces`

```
set_result_traces(data_ptr: i32, data_size: i32) -> void
```

Submits processed traces data (OTLP protobuf binary) back to the host.

**Valid context**: During `process_traces` and `start_traces_receiver` invocations.

- For **processors**: submits the modified traces to continue through the pipeline.
- For **receivers**: emits generated traces into the pipeline. MAY be called multiple times
  during a single receiver invocation.

#### `set_result_metrics`

```
set_result_metrics(data_ptr: i32, data_size: i32) -> void
```

Submits processed metrics data back to the host.

**Valid context**: During `process_metrics` and `start_metrics_receiver` invocations.

#### `set_result_logs`

```
set_result_logs(data_ptr: i32, data_size: i32) -> void
```

Submits processed logs data back to the host.

**Valid context**: During `process_logs` and `start_logs_receiver` invocations.

### 7.3 Configuration

#### `get_plugin_config`

```
get_plugin_config(buf_ptr: i32, buf_limit: i32) -> i32
```

Retrieves the plugin configuration as a JSON-encoded byte string using the buffer-passing
convention (§4.2). The JSON content corresponds to the `plugin_config` section of the
component's YAML configuration.

**Valid context**: At any time after module instantiation.

### 7.4 Status Reporting

#### `set_status_reason`

```
set_status_reason(msg_ptr: i32, msg_size: i32) -> void
```

Sets a human-readable UTF-8 error message. This SHOULD be called before returning a non-zero
status code from any guest function. The host reads `msg_size` bytes starting at `msg_ptr`.

**Valid context**: At any time during a guest function invocation.

### 7.5 Lifecycle Support

#### `get_shutdown_requested`

```
get_shutdown_requested() -> i32
```

Returns `1` if the host has requested shutdown, `0` otherwise.

**Valid context**: Primarily used within receiver loops to detect graceful shutdown. MAY be
called at any time.

### 7.6 Logging

#### `log`

```
log(level: i32, msg_ptr: i32, msg_size: i32) -> void
```

Emits a log message through the host's logging infrastructure (typically the OpenTelemetry
Collector's logger). The message MUST be a valid UTF-8 string.

- `level` — One of the log levels defined in §3.3.
- `msg_ptr` — Pointer to the UTF-8 message in guest memory.
- `msg_size` — Length of the message in bytes.

The host SHOULD forward the message to its configured logger at the appropriate level. Messages
with a level below the host's configured threshold MAY be silently discarded.

**Valid context**: At any time after module instantiation.

---

## 8. Guest Functions

These functions are exported by the guest module and called by the host.

### 8.1 Required Exports

Every otelwasm v1 plugin MUST export the following functions.

#### `abi_version_v1`

```
abi_version_v1() -> void
```

ABI version marker (see §5.1). Never called by the host.

#### `get_supported_telemetry`

```
get_supported_telemetry() -> i32
```

Returns a bitmask of supported telemetry types (see §3.2). The host uses this to validate
that the plugin supports the required signals for its configured role.

#### `plugin_init`

```
plugin_init() -> i32
```

Called once during plugin initialization (see §6.4). Returns a `StatusCode` (§3.1).

#### `plugin_shutdown`

```
plugin_shutdown() -> i32
```

Called once during plugin shutdown (see §6.6). Returns a `StatusCode` (§3.1).

### 8.2 Processor Functions

Plugins acting as **processors** MUST export one or more of the following, corresponding to
the telemetry types declared by `get_supported_telemetry()`.

#### `process_traces`

```
process_traces() -> i32
```

Process a batch of traces. The guest SHOULD:

1. Call `get_current_traces()` to retrieve input data.
2. Process/transform the data.
3. Call `set_result_traces()` to submit the result.
4. Return a `StatusCode`.

If `set_result_traces()` is not called and the function returns `SUCCESS`, the host SHOULD
treat the original data as unchanged and pass it through.

#### `process_metrics`

```
process_metrics() -> i32
```

Process a batch of metrics. Same protocol as `process_traces`.

#### `process_logs`

```
process_logs() -> i32
```

Process a batch of logs. Same protocol as `process_traces`.

### 8.3 Exporter Functions

Plugins acting as **exporters** MUST export one or more of the following.

#### `push_traces`

```
push_traces() -> i32
```

Export a batch of traces. The guest SHOULD:

1. Call `get_current_traces()` to retrieve input data.
2. Send the data to the external destination.
3. Return a `StatusCode`.

#### `push_metrics`

```
push_metrics() -> i32
```

Export a batch of metrics. Same protocol as `push_traces`.

#### `push_logs`

```
push_logs() -> i32
```

Export a batch of logs. Same protocol as `push_traces`.

### 8.4 Receiver Functions

Plugins acting as **receivers** MUST export one or more of the following.

#### `start_traces_receiver`

```
start_traces_receiver() -> void
```

Start the traces receiver. This function **blocks** until shutdown is requested. The guest
SHOULD:

1. Enter a loop.
2. Generate or collect telemetry data.
3. Call `set_result_traces()` to emit data into the pipeline.
4. Check `get_shutdown_requested()` periodically.
5. Exit the loop when shutdown is indicated.

#### `start_metrics_receiver`

```
start_metrics_receiver() -> void
```

Start the metrics receiver. Same protocol as `start_traces_receiver`.

#### `start_logs_receiver`

```
start_logs_receiver() -> void
```

Start the logs receiver. Same protocol as `start_traces_receiver`.

---

## 9. Data Serialization

### 9.1 Telemetry Data

All telemetry data exchanged between host and guest MUST be serialized using **Protocol Buffers
binary encoding** with the following message types from the
[OpenTelemetry Proto](https://github.com/open-telemetry/opentelemetry-proto) definitions:

| Signal  | Protobuf Message                                |
|---------|--------------------------------------------------|
| Traces  | `opentelemetry.proto.trace.v1.TracesData`        |
| Metrics | `opentelemetry.proto.metrics.v1.MetricsData`     |
| Logs    | `opentelemetry.proto.logs.v1.LogsData`           |

These are the same internal data representations used by the OpenTelemetry Collector's
`pdata` package (`ptrace.Traces`, `pmetric.Metrics`, `plog.Logs`).

### 9.2 Configuration

Plugin configuration MUST be serialized as **UTF-8 encoded JSON**. The JSON structure
corresponds to the `plugin_config` section of the component's YAML configuration, converted
using the standard YAML-to-JSON mapping.

### 9.3 Text Data

All text data exchanged through the ABI (status reasons, log messages) MUST be valid **UTF-8**
encoded strings.

---

## 10. Error Handling

### 10.1 Guest Function Errors

When a guest function returns a non-zero `StatusCode`:

1. The guest SHOULD call `set_status_reason()` before returning to provide a human-readable
   error description.
2. The host SHOULD log the error, including the status reason if available.
3. The host SHOULD propagate the error to the OpenTelemetry Collector pipeline, which may
   trigger retry logic or error reporting depending on the pipeline configuration.

### 10.2 Host Function Errors

Host functions that use the buffer-passing convention signal "no data available" by returning
`0`. The host MAY **trap** (abort) the WASM module for unrecoverable errors such as:

- Guest passes an invalid memory address.
- Guest calls a function outside its valid context (e.g., calling `get_current_traces()` during
  a `process_logs()` invocation).

### 10.3 WASM Traps

If a WASM trap occurs (e.g., unreachable instruction, out-of-bounds memory access, stack
overflow), the host SHOULD:

1. Log the trap with available diagnostic information.
2. Report the error to the OpenTelemetry Collector pipeline.
3. The host MAY optionally restart the WASM module for subsequent invocations.

---

## 11. WASI Support

Guest modules MAY use [WASI preview 1](https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md)
imports for:

- Standard I/O (`fd_write` to stdout/stderr)
- Clock access (`clock_time_get`)
- Random number generation (`random_get`)
- Environment variables (`environ_get`, `environ_sizes_get`)

The host SHOULD provide WASI preview 1 support. Output written to stdout and stderr SHOULD be
forwarded to the host's logging infrastructure.

> **Note**: Guest modules SHOULD prefer the `log` host function (§7.6) over WASI stdio for
> logging, as it provides structured log levels.

---

## Appendix A: Complete ABI Reference

### Host Functions (import module: `otelwasm`)

| Function                 | WASM Signature              | Description                        |
|--------------------------|-----------------------------|------------------------------------|
| `get_current_traces`     | `(i32, i32) -> (i32)`      | Read current traces into buffer    |
| `get_current_metrics`    | `(i32, i32) -> (i32)`      | Read current metrics into buffer   |
| `get_current_logs`       | `(i32, i32) -> (i32)`      | Read current logs into buffer      |
| `set_result_traces`      | `(i32, i32) -> ()`         | Submit result traces               |
| `set_result_metrics`     | `(i32, i32) -> ()`         | Submit result metrics              |
| `set_result_logs`        | `(i32, i32) -> ()`         | Submit result logs                 |
| `get_plugin_config`      | `(i32, i32) -> (i32)`      | Read plugin configuration (JSON)   |
| `set_status_reason`      | `(i32, i32) -> ()`         | Set error reason string            |
| `get_shutdown_requested` | `() -> (i32)`               | Check shutdown flag                |
| `log`                    | `(i32, i32, i32) -> ()`    | Emit log message                   |

### Guest Exports

| Function                   | WASM Signature  | Required | Description                   |
|----------------------------|-----------------|----------|-------------------------------|
| `abi_version_v1`           | `() -> ()`      | Yes      | ABI version marker            |
| `get_supported_telemetry`  | `() -> (i32)`   | Yes      | Supported telemetry bitmask   |
| `plugin_init`              | `() -> (i32)`   | Yes      | Initialize plugin             |
| `plugin_shutdown`          | `() -> (i32)`   | Yes      | Shutdown plugin               |
| `process_traces`           | `() -> (i32)`   | No\*     | Process traces                |
| `process_metrics`          | `() -> (i32)`   | No\*     | Process metrics               |
| `process_logs`             | `() -> (i32)`   | No\*     | Process logs                  |
| `push_traces`              | `() -> (i32)`   | No\*     | Export traces                 |
| `push_metrics`             | `() -> (i32)`   | No\*     | Export metrics                |
| `push_logs`                | `() -> (i32)`   | No\*     | Export logs                   |
| `start_traces_receiver`    | `() -> ()`      | No\*     | Start traces receiver         |
| `start_metrics_receiver`   | `() -> ()`      | No\*     | Start metrics receiver        |
| `start_logs_receiver`      | `() -> ()`      | No\*     | Start logs receiver           |

\* Required based on the component type and the telemetry signals declared by
`get_supported_telemetry()`.

---

## Appendix B: Migration from Experimental ABI

### B.1 Breaking Changes

| Experimental ABI                  | v1 ABI                       | Change                        |
|-----------------------------------|------------------------------|-------------------------------|
| Module: `opentelemetry.io/wasm`   | Module: `otelwasm`           | Module name simplified        |
| `currentTraces`                   | `get_current_traces`         | Renamed (snake\_case)         |
| `currentMetrics`                  | `get_current_metrics`        | Renamed                       |
| `currentLogs`                     | `get_current_logs`           | Renamed                       |
| `setResultTraces`                 | `set_result_traces`          | Renamed                       |
| `setResultMetrics`                | `set_result_metrics`         | Renamed                       |
| `setResultLogs`                   | `set_result_logs`            | Renamed                       |
| `getPluginConfig`                 | `get_plugin_config`          | Renamed                       |
| `setResultStatusReason`           | `set_status_reason`          | Renamed, shortened            |
| `getShutdownRequested`            | `get_shutdown_requested`     | Renamed                       |
| `getSupportedTelemetry`           | `get_supported_telemetry`    | Renamed                       |
| `processTraces`                   | `process_traces`             | Renamed                       |
| `processMetrics`                  | `process_metrics`            | Renamed                       |
| `processLogs`                     | `process_logs`               | Renamed                       |
| `pushTraces`                      | `push_traces`                | Renamed                       |
| `pushMetrics`                     | `push_metrics`               | Renamed                       |
| `pushLogs`                        | `push_logs`                  | Renamed                       |
| `startTracesReceiver`             | `start_traces_receiver`      | Renamed                       |
| `startMetricsReceiver`            | `start_metrics_receiver`     | Renamed                       |
| `startLogsReceiver`               | `start_logs_receiver`        | Renamed                       |
| *(not present)*                   | `abi_version_v1`             | **New**: ABI version marker   |
| *(not present)*                   | `plugin_init`                | **New**: Lifecycle init        |
| *(not present)*                   | `plugin_shutdown`            | **New**: Lifecycle shutdown    |
| *(not present)*                   | `log`                        | **New**: Structured logging    |

### B.2 Migration Strategy

The host SHOULD support both the experimental ABI and v1 ABI simultaneously during a transition
period:

1. On module load, check for `abi_version_v1` export.
2. If present, use v1 ABI function names and lifecycle.
3. If absent, fall back to experimental ABI function names (camelCase, no lifecycle hooks).

This allows existing plugins to continue working while new plugins adopt v1.

---

## Appendix C: Future Considerations

The following features are **out of scope** for v1 but are being considered for future versions:

- **HTTP client host functions** — Enabling exporters to make outbound HTTP requests from within
  the WASM sandbox.
- **Timer/tick model for receivers** — An alternative to the blocking receiver model where the
  host periodically calls a guest tick function.
- **Profiles signal support** — When the OpenTelemetry profiles signal stabilizes, a new
  telemetry type flag and corresponding functions will be added.
- **Connector component support** — OpenTelemetry Collector connectors bridge between pipelines;
  ABI support may be added in the future.
- **Plugin metadata** — Guest-declared metadata such as plugin name, version, and description.
- **Shared state / key-value store** — Host-managed shared state accessible to plugins, similar
  to proxy-wasm's shared data mechanism.
- **Backpressure signaling** — Mechanism for the host to signal the guest to slow down data
  emission (relevant for receivers).
